<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Amigos Virtuales Axel</title>
    <script src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;700;900&display=swap');
        body { 
            font-family: 'Inter', sans-serif; 
            -webkit-tap-highlight-color: transparent; 
            background: linear-gradient(135deg, #667eea 0%, #764ba2 25%, #f093fb 50%, #4facfe 75%, #00f2fe 100%);
            background-size: 400% 400%;
            animation: gradientShift 15s ease infinite;
            color: white;
            position: relative;
            overflow-x: hidden;
        }
        
        @keyframes gradientShift {
            0% { background-position: 0% 50%; }
            50% { background-position: 100% 50%; }
            100% { background-position: 0% 50%; }
        }
        
        body::before {
            content: '';
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: 
                radial-gradient(circle at 20% 30%, rgba(255,255,255,0.1) 0%, transparent 50%),
                radial-gradient(circle at 80% 70%, rgba(255,255,255,0.15) 0%, transparent 50%),
                radial-gradient(circle at 50% 50%, rgba(0,0,0,0.1) 0%, transparent 50%);
            pointer-events: none;
            z-index: 1;
        }
        
        #root {
            position: relative;
            z-index: 2;
        }
        
        .no-scrollbar::-webkit-scrollbar { display: none; }
        .active-scale:active { transform: scale(0.95); }
        
        .chat-container { 
            height: 100vh; 
            height: 100dvh;
        }
        .chat-footer {
            padding-bottom: env(safe-area-inset-bottom, 16px);
        }
    </style>
</head>
<body>
    <div id="root"></div>

    <script type="text/babel">
        const { useState, useEffect, useRef } = React;

        const Icons = {
            Send: () => <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><line x1="22" y1="2" x2="11" y2="13"></line><polygon points="22 2 15 22 11 13 2 9 22 2"></polygon></svg>,
            Volume2: () => <svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><polygon points="11 5 6 9 2 9 2 15 6 15 11 19 11 5"></polygon><path d="M19.07 4.93a10 10 0 0 1 0 14.14"></path><path d="M15.53 8.47a5 5 0 0 1 0 7.07"></path></svg>,
            UserPlus: () => <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M16 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2"></path><circle cx="8.5" cy="7" r="4"></circle><line x1="20" y1="8" x2="20" y2="14"></line><line x1="23" y1="11" x2="17" y2="11"></line></svg>,
            Trash2: () => <svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><polyline points="3 6 5 6 21 6"></polyline><path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"></path><line x1="10" y1="11" x2="10" y2="17"></line><line x1="14" y1="11" x2="14" y2="17"></line></svg>,
            ChevronLeft: () => <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><polyline points="15 18 9 12 15 6"></polyline></svg>,
            Sparkles: () => <svg xmlns="http://www.w3.org/2000/svg" width="32" height="32" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="m12 3-1.912 5.813a2 2 0 0 1-1.275 1.275L3 12l5.813 1.912a2 2 0 0 1 1.275 1.275L12 21l1.912-5.813a2 2 0 0 1 1.275-1.275L21 12l-5.813-1.912a2 2 0 0 1-1.275-1.275L12 3Z"></path><path d="M5 3v4"></path><path d="M19 17v4"></path><path d="M3 5h4"></path><path d="M17 19h4"></path></svg>,
            Loader2: () => <svg className="animate-spin" xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><line x1="12" y1="2" x2="12" y2="6"></line><line x1="12" y1="18" x2="12" y2="22"></line><line x1="4.93" y1="4.93" x2="7.76" y2="7.76"></line><line x1="16.24" y1="16.24" x2="19.07" y2="19.07"></line><line x1="2" y1="12" x2="6" y2="12"></line><line x1="18" y1="12" x2="22" y2="12"></line><line x1="4.93" y1="19.07" x2="7.76" y2="16.24"></line><line x1="16.24" y1="7.76" x2="19.07" y2="4.93"></line></svg>
        };

        const apiKey = "AIzaSyD_AuLpGJLphHFuSRn_myPMSz1S8owpphE"; 

        const AVAILABLE_VOICES = [
            { id: "Charon", name: "Charon" },
            { id: "Fenrir", name: "Fenrir" },
            { id: "Kore", name: "Kore" },
            { id: "Zephyr", name: "Zephyr" }
        ];

        const App = () => {
            const [friends, setFriends] = useState(() => {
                const saved = localStorage.getItem('my_virtual_friends_v2');
                return saved ? JSON.parse(saved) : [];
            });
            
            const [activeFriendId, setActiveFriendId] = useState(null);
            const [view, setView] = useState('gallery'); 
            const [messages, setMessages] = useState([]);
            const [input, setInput] = useState('');
            const [isTyping, setIsTyping] = useState(false);
            const [audioProgress, setAudioProgress] = useState(0);
            
            const [newFriend, setNewFriend] = useState({
                name: '', description: '', profilePic: '', backgroundPic: '', voice: 'Charon', prompt: ''
            });

            const messagesEndRef = useRef(null);
            const audioRef = useRef(null);

            useEffect(() => {
                localStorage.setItem('my_virtual_friends_v2', JSON.stringify(friends));
            }, [friends]);

            useEffect(() => {
                messagesEndRef.current?.scrollIntoView({ behavior: "smooth" });
            }, [messages]);

            const activeFriend = friends.find(f => f.id === activeFriendId);

            const playSpeech = async (text) => {
                if (!text || !activeFriend) return;
                try {
                    const response = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-tts:generateContent?key=${apiKey}`, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({
                            contents: [{ parts: [{ text: text }] }],
                            generationConfig: {
                                responseModalities: ["AUDIO"],
                                speechConfig: { voiceConfig: { prebuiltVoiceConfig: { voiceName: activeFriend.voice } } }
                            }
                        })
                    });
                    const result = await response.json();
                    const pcmBase64 = result.candidates?.[0]?.content?.parts?.[0]?.inlineData?.data;
                    if (pcmBase64) {
                        const pcmData = Uint8Array.from(atob(pcmBase64), c => c.charCodeAt(0));
                        const sampleRate = 24000; 
                        const wavHeader = new ArrayBuffer(44);
                        const view = new DataView(wavHeader);
                        const writeString = (offset, string) => { for (let i = 0; i < string.length; i++) view.setUint8(offset + i, string.charCodeAt(i)); };
                        writeString(0, 'RIFF'); view.setUint32(4, 36 + pcmData.length, true); writeString(8, 'WAVE'); writeString(12, 'fmt ');
                        view.setUint32(16, 16, true); view.setUint16(20, 1, true); view.setUint16(22, 1, true); view.setUint32(24, sampleRate, true);
                        view.setUint32(28, sampleRate * 2, true); view.setUint16(32, 2, true); view.setUint16(34, 16, true); writeString(36, 'data');
                        view.setUint32(40, pcmData.length, true);
                        const blob = new Blob([wavHeader, pcmData], { type: 'audio/wav' });
                        if (audioRef.current) {
                            audioRef.current.src = URL.createObjectURL(blob);
                            audioRef.current.play();
                        }
                    }
                } catch (e) { console.error(e); }
            };

            const fetchChatResponse = async (userText) => {
                if (!activeFriend) return;
                setIsTyping(true);
                try {
                    const response = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-09-2025:generateContent?key=${apiKey}`, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({
                            contents: [{ parts: [{ text: userText }] }],
                            systemInstruction: { parts: [{ text: `Nombre: ${activeFriend.name}. Eres: ${activeFriend.description}. Personalidad: ${activeFriend.prompt}. SÃ© breve y muy humano.` }] }
                        })
                    });
                    const result = await response.json();
                    const botText = result.candidates?.[0]?.content?.parts?.[0]?.text || "...";
                    setMessages(prev => [...prev, { id: Date.now(), text: botText, sender: 'bot' }]);
                    playSpeech(botText);
                } catch (e) { console.error(e); } finally { setIsTyping(false); }
            };

            const saveFriend = () => {
                if (!newFriend.name || !newFriend.prompt) return;
                const friendToSave = {
                    ...newFriend,
                    id: Date.now(),
                    profilePic: newFriend.profilePic || 'https://images.unsplash.com/photo-1535713875002-d1d0cf377fde?w=200',
                    backgroundPic: newFriend.backgroundPic || 'https://images.unsplash.com/photo-1557683316-973673baf926?w=800'
                };
                setFriends([...friends, friendToSave]);
                setNewFriend({ name: '', description: '', profilePic: '', backgroundPic: '', voice: 'Charon', prompt: '' });
                setView('gallery');
            };

            const startChat = (friend) => {
                setActiveFriendId(friend.id);
                setMessages([{ id: 1, text: `Â¡Hola! Soy ${friend.name}. Â¿QuÃ© onda?`, sender: 'bot' }]);
                setView('chat');
            };

            if (view === 'gallery') {
                return (
                    <div className="min-h-screen text-white p-4">
                        <div className="max-w-4xl mx-auto space-y-6">
                            <header className="flex justify-between items-end pb-4 border-b border-white/20 backdrop-blur-sm bg-white/5 rounded-2xl px-4 pt-4">
                                <div>
                                    <h1 className="text-3xl font-black tracking-tight bg-gradient-to-r from-white to-blue-200 bg-clip-text text-transparent">Amigos Virtuales Axel</h1>
                                    <p className="text-blue-200 text-[10px] font-bold uppercase tracking-widest">CatÃ¡logo Personal</p>
                                </div>
                                <button onClick={() => setView('create')} className="bg-gradient-to-r from-blue-500 to-purple-600 p-3 rounded-xl active-scale transition-all shadow-lg shadow-purple-500/30 hover:shadow-purple-500/50">
                                    <Icons.UserPlus />
                                </button>
                            </header>

                            <div className="grid grid-cols-2 md:grid-cols-3 gap-3">
                                {friends.map(friend => (
                                    <div key={friend.id} onClick={() => startChat(friend)} className="relative overflow-hidden rounded-2xl bg-black/40 backdrop-blur-md border border-white/20 aspect-[4/5] active-scale transition-all hover:border-white/40 shadow-xl">
                                        <img src={friend.profilePic} className="absolute inset-0 w-full h-full object-cover opacity-50" />
                                        <div className="absolute inset-0 bg-gradient-to-t from-black via-transparent to-transparent"></div>
                                        <button onClick={(e) => { e.stopPropagation(); setFriends(friends.filter(f => f.id !== friend.id)); }} className="absolute top-2 right-2 p-1.5 bg-red-500/80 backdrop-blur-md text-white rounded-lg hover:bg-red-600 transition-all">
                                            <Icons.Trash2 />
                                        </button>
                                        <div className="absolute bottom-3 left-3 right-3">
                                            <div className="flex items-center gap-1.5">
                                                <div className="w-1.5 h-1.5 bg-green-500 rounded-full animate-pulse shadow-[0_0_5px_green]"></div>
                                                <span className="text-[8px] font-black text-blue-400 uppercase tracking-widest">Online</span>
                                            </div>
                                            <h3 className="text-sm font-black truncate">{friend.name}</h3>
                                            <p className="text-[9px] text-slate-400 font-bold truncate">{friend.description}</p>
                                        </div>
                                    </div>
                                ))}
                                {friends.length === 0 && (
                                    <div className="col-span-full py-20 text-center border-2 border-dashed border-white/30 rounded-2xl bg-white/10 backdrop-blur-md">
                                        <Icons.Sparkles className="mx-auto text-white mb-2" />
                                        <p className="text-white text-sm font-bold">AÃºn no has creado amigos</p>
                                        <button onClick={() => setView('create')} className="mt-3 px-6 py-2 bg-gradient-to-r from-blue-500 to-purple-600 text-white font-bold text-xs rounded-full shadow-lg hover:shadow-xl transition-all">Crear Primero</button>
                                    </div>
                                )}
                            </div>
                        </div>
                    </div>
                );
            }

            if (view === 'create') {
                return (
                    <div className="min-h-screen text-white p-6">
                        <div className="max-w-md mx-auto space-y-4">
                            <button onClick={() => setView('gallery')} className="flex items-center gap-2 text-slate-200 text-[10px] font-black uppercase tracking-widest active-scale">
                                <Icons.ChevronLeft /> Volver
                            </button>
                            <div className="bg-black/40 backdrop-blur-md p-6 rounded-3xl border border-white/20 space-y-4">
                                <h2 className="text-lg font-black">Nuevo Perfil</h2>
                                <div className="bg-blue-900/20 border border-blue-500/30 rounded-xl p-3 text-xs text-blue-300">
                                    <p className="font-bold mb-1">ðŸ’¡ Ejemplos de URLs:</p>
                                    <p className="text-[10px] opacity-80">â€¢ Unsplash: unsplash.com/photos/...</p>
                                    <p className="text-[10px] opacity-80">â€¢ Imgur: i.imgur.com/...</p>
                                    <p className="text-[10px] opacity-80">â€¢ Tu servidor: tudominio.com/imagen.jpg</p>
                                </div>
                                <input type="text" value={newFriend.name} onChange={e => setNewFriend({...newFriend, name: e.target.value})} className="w-full bg-white/5 rounded-xl px-4 py-3 outline-none text-sm border border-white/5 focus:border-blue-500" placeholder="Nombre" />
                                <input type="text" value={newFriend.description} onChange={e => setNewFriend({...newFriend, description: e.target.value})} className="w-full bg-white/5 rounded-xl px-4 py-3 outline-none text-sm border border-white/5 focus:border-blue-500" placeholder="Etiqueta (Ej: Boxeador)" />
                                <div className="space-y-2">
                                    <label className="text-[10px] font-black text-slate-400 uppercase tracking-widest">Foto de Perfil (CÃ­rculo)</label>
                                    <input type="text" value={newFriend.profilePic} onChange={e => setNewFriend({...newFriend, profilePic: e.target.value})} className="w-full bg-white/5 rounded-xl px-4 py-3 outline-none text-sm border border-white/5 focus:border-blue-500" placeholder="https://..." />
                                    {newFriend.profilePic && <img src={newFriend.profilePic} className="w-16 h-16 rounded-full object-cover border-2 border-blue-500" onError={(e) => e.target.style.display = 'none'} />}
                                </div>
                                <div className="space-y-2">
                                    <label className="text-[10px] font-black text-slate-400 uppercase tracking-widest">Fondo del Chat</label>
                                    <input type="text" value={newFriend.backgroundPic} onChange={e => setNewFriend({...newFriend, backgroundPic: e.target.value})} className="w-full bg-white/5 rounded-xl px-4 py-3 outline-none text-sm border border-white/5 focus:border-blue-500" placeholder="https://..." />
                                    {newFriend.backgroundPic && <div className="w-full h-20 rounded-lg bg-cover bg-center border-2 border-blue-500" style={{backgroundImage: `url(${newFriend.backgroundPic})`}}></div>}
                                </div>
                                <div className="grid grid-cols-2 gap-2">
                                    {AVAILABLE_VOICES.map(v => (
                                        <button key={v.id} onClick={() => setNewFriend({...newFriend, voice: v.id})} className={`py-2 rounded-lg text-[10px] font-black border transition-all ${newFriend.voice === v.id ? 'border-blue-500 bg-blue-600' : 'border-white/5 text-slate-500'}`}>{v.name}</button>
                                    ))}
                                </div>
                                <textarea value={newFriend.prompt} onChange={e => setNewFriend({...newFriend, prompt: e.target.value})} className="w-full bg-white/5 rounded-xl px-4 py-3 outline-none text-sm h-24 resize-none border border-white/5 focus:border-blue-500" placeholder="Personalidad..." />
                                <button onClick={saveFriend} className="w-full bg-gradient-to-r from-blue-500 to-purple-600 py-4 rounded-xl font-black text-xs tracking-widest active-scale shadow-lg shadow-purple-600/20">GUARDAR AMIGO</button>
                            </div>
                        </div>
                    </div>
                );
            }

            return (
                <div className="flex flex-col chat-container text-slate-800" style={{backgroundImage: `linear-gradient(rgba(0,0,0,0.7), rgba(0,0,0,0.7)), url(${activeFriend.backgroundPic})`, backgroundSize: 'cover', backgroundPosition: 'center'}}>
                    <header className="bg-white/95 backdrop-blur-md p-4 flex items-center justify-between border-b border-white/10 shadow-lg z-10 shrink-0">
                        <div className="flex items-center">
                            <button onClick={() => setView('gallery')} className="mr-2 p-2 active-scale"><Icons.ChevronLeft /></button>
                            <img src={activeFriend.profilePic} className="w-10 h-10 rounded-xl object-cover border border-blue-100 shadow-sm" />
                            <div className="ml-3">
                                <h1 className="font-black text-sm">{activeFriend.name}</h1>
                                <p className="text-[9px] font-black text-blue-600 uppercase tracking-widest">{activeFriend.description}</p>
                            </div>
                        </div>
                        <div className="flex items-center gap-1.5 bg-green-50 px-2 py-1 rounded-full">
                            <div className="w-1.5 h-1.5 bg-green-500 rounded-full animate-pulse"></div>
                            <span className="text-[8px] font-black text-green-700 uppercase">Live</span>
                        </div>
                    </header>
                    <div className="w-full h-1 bg-white/10 shrink-0"><div className="h-full bg-blue-500 transition-all shadow-[0_0_8px_blue]" style={{ width: `${audioProgress}%` }}></div></div>
                    <audio ref={audioRef} onTimeUpdate={() => setAudioProgress((audioRef.current.currentTime / audioRef.current.duration) * 100)} onEnded={() => setAudioProgress(0)} />
                    <main className="flex-1 overflow-y-auto p-4 space-y-4 no-scrollbar pb-24">
                        {messages.map((msg, i) => (
                            <div key={i} className={`flex ${msg.sender === 'user' ? 'justify-end' : 'justify-start'} animate-in fade-in slide-in-from-bottom-2`}>
                                <div className={`max-w-[85%] px-4 py-2.5 rounded-2xl shadow-xl ${msg.sender === 'user' ? 'bg-blue-600 text-white rounded-br-none' : 'bg-white text-slate-800 rounded-bl-none'}`}>
                                    <p className="text-sm font-medium leading-relaxed">{msg.text}</p>
                                    {msg.sender === 'bot' && (
                                        <button onClick={() => playSpeech(msg.text)} className="mt-2 p-1 bg-blue-50 text-blue-600 rounded-full active-scale transition-all">
                                            <Icons.Volume2 />
                                        </button>
                                    )}
                                </div>
                            </div>
                        ))}
                        {isTyping && <div className="text-white text-[9px] font-black tracking-widest animate-pulse ml-2 uppercase">Escribiendo...</div>}
                        <div ref={messagesEndRef} />
                    </main>
                    <footer className="p-4 bg-white/95 backdrop-blur-md shrink-0 chat-footer">
                        <form onSubmit={(e) => { e.preventDefault(); if (input.trim()) { const t = input; setMessages(p => [...p, { text: t, sender: 'user' }]); setInput(''); fetchChatResponse(t); } }} className="flex gap-2 max-w-3xl mx-auto">
                            <input type="text" value={input} onChange={e => setInput(e.target.value)} className="flex-1 bg-slate-100 rounded-xl px-4 py-3 text-sm outline-none focus:ring-2 focus:ring-blue-500/50" placeholder="Di algo..." />
                            <button className="bg-gradient-to-r from-blue-500 to-purple-600 text-white p-3 rounded-xl active-scale shadow-lg shadow-purple-600/20">
                                {isTyping ? <Icons.Loader2 /> : <Icons.Send />}
                            </button>
                        </form>
                    </footer>
                </div>
            );
        };

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>