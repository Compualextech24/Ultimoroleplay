<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Configura tu IA</title>
    <script src="https://js.puter.com/v2/"></script>
    <style>
        body { font-family: 'Segoe UI', sans-serif; background-color: #f0f2f5; display: flex; justify-content: center; align-items: center; min-height: 100vh; margin: 0; }
        #config-container, #chat-container { width: 450px; background: white; padding: 25px; border-radius: 15px; box-shadow: 0 4px 15px rgba(0,0,0,0.1); }
        #chat-container { display: none; flex-direction: column; height: 600px; padding: 0; }
        
        .field { margin-bottom: 15px; }
        label { display: block; font-weight: bold; margin-bottom: 5px; color: #444; }
        input, textarea, select { width: 100%; padding: 10px; border: 1px solid #ccc; border-radius: 8px; box-sizing: border-box; }
        
        .btn { width: 100%; padding: 12px; border: none; border-radius: 8px; cursor: pointer; font-weight: bold; margin-top: 10px; }
        #btn-start { background: #25d366; color: white; }
        #btn-test { background: #e4e6eb; color: #444; }
        
        #messages { flex: 1; padding: 15px; overflow-y: auto; display: flex; flex-direction: column; gap: 10px; }
        #input-area { display: flex; padding: 15px; background: #f0f0f0; }
        .user-msg { align-self: flex-end; background: #0084ff; color: white; padding: 10px 15px; border-radius: 15px 15px 0 15px; max-width: 80%; }
        .ia-msg { align-self: flex-start; background: #e4e6eb; color: black; padding: 10px 15px; border-radius: 15px 15px 15px 0; max-width: 80%; }
        
        #credits-info { background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; padding: 15px; border-radius: 10px; margin-bottom: 20px; text-align: center; font-weight: bold; }
        #credits-amount { font-size: 24px; margin-top: 5px; }
    </style>
</head>
<body>

<div id="config-container">
    <h2 style="text-align: center;">Configura tu IA</h2>
    
    <div id="credits-info">
        <div>ðŸ’° CrÃ©ditos Puter Disponibles</div>
        <div id="credits-amount">Cargando...</div>
    </div>
    
    <!-- Selector de modelo principal -->
    <div class="field">
        <label>Modelo de Texto (IA):</label>
        <select id="ai-model">
            <option value="groq" selected>Groq (Llama 3.3 - Â¡MÃ¡s rÃ¡pido!)</option>
            <option value="openai">OpenAI (GPT-4o-mini)</option>
        </select>
    </div>

    <div class="field">
        <label>Voz (TTS):</label>
        <select id="voice-model-type" onchange="actualizarListaVoces()">
            <option value="gemini">Google Gemini TTS</option>
            <option value="puter">Puter AI (Neural)</option>
        </select>
    </div>
    
    <div class="field">
        <label>Nombre de la IA:</label>
        <input type="text" id="ai-name" placeholder="Ej: Kasandra">
    </div>
    
    <div class="field">
        <label>Personalidad:</label>
        <textarea id="ai-persona" rows="2" placeholder="Ej: Amigable y atenta"></textarea>
    </div>
    
    <div class="field">
        <label>Tono de voz:</label>
        <select id="voice-select">
            <!-- DinÃ¡mico -->
        </select>
    </div>
    
    <button id="btn-test" class="btn">Escuchar Prueba</button>
    <button id="btn-start" class="btn">Empezar Chat</button>
</div>

<div id="chat-container">
    <div id="messages"></div>
    <div id="input-area">
        <input type="text" id="user-input" placeholder="Escribe un mensaje...">
        <button id="btn-enviar" style="margin-left:10px; background:#0084ff; color:white; border:none; border-radius:20px; padding:10px 20px; cursor:pointer;">Enviar</button>
    </div>
</div>

<script>
    const GEMINI_API_KEY = "AIzaSyDMU2cOfpvHAmeATJRHynsGKxtIS7Tc9XU";
    const OPENAI_API_KEY = "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";
    const GROQ_API_KEY = "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";

    let nombreIA = "", personalidadIA = "";
    
    const VOCES_PUTER = `
        <optgroup label="MÃ©xico">
            <option value="Andres-neural">AndrÃ©s</option>
            <option value="Mia-neural">Mia</option>
        </optgroup>
        <optgroup label="EspaÃ±a">
            <option value="Lucia-neural">LucÃ­a</option>
            <option value="Sergio-neural">Sergio</option>
        </optgroup>
    `;

    const VOCES_GEMINI = `
        <optgroup label="Google Premium">
            <option value="Kore">Kore (Femenina)</option>
            <option value="Zephyr">Zephyr (Masculina)</option>
            <option value="Charon">Charon (Profunda)</option>
            <option value="Puck">Puck (Juvenil)</option>
            <option value="Aoede">Aoede (Clara)</option>
        </optgroup>
    `;

    function actualizarListaVoces() {
        const tipo = document.getElementById('voice-model-type').value;
        const select = document.getElementById('voice-select');
        select.innerHTML = (tipo === 'puter') ? VOCES_PUTER : VOCES_GEMINI;
    }

    window.addEventListener('DOMContentLoaded', async () => {
        actualizarListaVoces();
        try {
            const usage = await puter.auth.getMonthlyUsage();
            document.getElementById('credits-amount').textContent = 
                usage?.monthly_limit ? `${(usage.monthly_limit - (usage.monthly_usage || 0)).toLocaleString()}` : "âˆž";
        } catch (e) { document.getElementById('credits-amount').textContent = "---"; }
    });

    async function hablar(texto) {
        const vozId = document.getElementById('voice-select').value;
        const tipo = document.getElementById('voice-model-type').value;

        if (tipo === 'puter') {
            const [voz, engine] = vozId.includes('-neural') ? [vozId.replace('-neural', ''), 'neural'] : [vozId, 'standard'];
            let lang = vozId.includes('Andres') || vozId.includes('Mia') ? 'es-MX' : 'es-ES';
            puter.ai.txt2speech(texto, { voice: voz, engine: engine, language: lang }).then(a => a.play());
        } else {
            try {
                const response = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-tts:generateContent?key=${GEMINI_API_KEY}`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        contents: [{ parts: [{ text: texto }] }],
                        generationConfig: {
                            responseModalities: ["AUDIO"],
                            speechConfig: { voiceConfig: { prebuiltVoiceConfig: { voiceName: vozId } } }
                        }
                    })
                });
                const data = await response.json();
                const audioBase64 = data.candidates?.[0]?.content?.parts?.[0]?.inlineData?.data;
                if (!audioBase64) return;

                const binaryString = atob(audioBase64);
                const bytes = new Uint8Array(binaryString.length);
                for (let i = 0; i < binaryString.length; i++) bytes[i] = binaryString.charCodeAt(i);

                const audioContext = new (window.AudioContext || window.webkitAudioContext)();
                const wavBuffer = createWavFile(bytes.buffer, 24000);
                const audioBuffer = await audioContext.decodeAudioData(wavBuffer);
                const source = audioContext.createBufferSource();
                source.buffer = audioBuffer;
                source.connect(audioContext.destination);
                source.start();
            } catch (err) { console.error("Voz error:", err); }
        }
    }

    function createWavFile(pcmData, sampleRate) {
        const buffer = new ArrayBuffer(44 + pcmData.byteLength);
        const view = new DataView(buffer);
        view.setUint32(0, 0x52494646, false);
        view.setUint32(4, 36 + pcmData.byteLength, true);
        view.setUint32(8, 0x57415645, false);
        view.setUint32(12, 0x666d7420, false);
        view.setUint32(16, 16, true);
        view.setUint16(20, 1, true);
        view.setUint16(22, 1, true);
        view.setUint32(24, sampleRate, true);
        view.setUint32(28, sampleRate * 2, true);
        view.setUint16(32, 2, true);
        view.setUint16(34, 16, true);
        view.setUint32(36, 0x64617461, false);
        view.setUint32(40, pcmData.byteLength, true);
        new Uint8Array(buffer, 44).set(new Uint8Array(pcmData));
        return buffer;
    }

    document.getElementById('btn-test').onclick = () => hablar("Hola, probando la voz.");

    document.getElementById('btn-start').onclick = () => {
        nombreIA = document.getElementById('ai-name').value || "IA";
        personalidadIA = document.getElementById('ai-persona').value || "Amistosa";
        document.getElementById('config-container').style.display = 'none';
        document.getElementById('chat-container').style.display = 'flex';
    };

    async function enviar() {
        const input = document.getElementById('user-input');
        const texto = input.value.trim();
        const modelSelection = document.getElementById('ai-model').value;
        if (!texto) return;

        const dUser = document.createElement('div');
        dUser.className = 'user-msg'; dUser.innerText = texto;
        document.getElementById('messages').appendChild(dUser);
        input.value = "";

        const dIA = document.createElement('div');
        dIA.className = 'ia-msg'; dIA.innerText = "...";
        document.getElementById('messages').appendChild(dIA);

        try {
            let respuestaTexto = "";
            if (modelSelection === 'groq') {
                const res = await fetch('https://api.groq.com/openai/v1/chat/completions', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json', 'Authorization': `Bearer ${GROQ_API_KEY}` },
                    body: JSON.stringify({
                        model: 'llama-3.3-70b-versatile',
                        messages: [{ role: 'system', content: `Eres ${nombreIA}. ${personalidadIA}.` }, { role: 'user', content: texto }]
                    })
                });
                const data = await res.json();
                respuestaTexto = data.choices[0].message.content;
            } else {
                const res = await fetch('https://api.openai.com/v1/chat/completions', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json', 'Authorization': `Bearer ${OPENAI_API_KEY}` },
                    body: JSON.stringify({
                        model: 'gpt-4o-mini',
                        messages: [{ role: 'system', content: `Eres ${nombreIA}. ${personalidadIA}.` }, { role: 'user', content: texto }]
                    })
                });
                const data = await res.json();
                respuestaTexto = data.choices[0].message.content;
            }
            dIA.innerText = respuestaTexto;
            hablar(respuestaTexto);
        } catch (e) { dIA.innerText = "Error: " + e.message; }
        document.getElementById('messages').scrollTop = document.getElementById('messages').scrollHeight;
    }

    document.getElementById('btn-enviar').onclick = enviar;
    document.getElementById('user-input').onkeypress = (e) => { if(e.key === 'Enter') enviar(); };
</script>

</body>
</html>
